{% extends 'base_dashboard.html' %}
{% block content %}

<br> 

<form class="form-inline my-2 my-lg-0" method="post">
  {% csrf_token %} 
  <div style="padding: 20px;">
  <input class="form-control mr-sm-2" type="date" placeholder="Search by Date" name="att_date" aria-label="Search">
  <button class="btn btn-outline-success my-2 my-sm-0" type="submit"> <i class="fa fa-search" aria-hidden="true"></i> Search</button>
  </div>
</form> <br> 

<div class="shadow-lg p-3 mb-5 rounded" style="border-radius: 15px; background-color: rgba(255,255,255,0.13); text-align: center;"><h3>Attendance Management</h3></div>
<br>
  




<div class="container">
  {% for msg in messages %}
          <div class="alert alert-warning alert-dismissible fade show" role="alert" style="background-color: rgb(187, 240, 187);">
               {{msg}}
              <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
              </button>
          </div>                
  {% endfor %}
</div> 





  <div style="padding: 3px;">
  <div class="table-responsive">

    <!-- START Mark Attendance button with MOdel -->
    <form action="javascript:void(0);" style="float: right;">
      <button type="button" class="btn btn-outline-success" data-toggle="modal" data-target="#markAttendanceModal">
        <i class="fa fa-plus"></i> Mark Attendance 
      </button>
    </form> <br><br>
    <!-- END - Mark Attendance button with model -->
    
  <table class="table" id="myTable" border="">
    <thead>
      <tr style="background-color: 	#ccccff; color: black;">
        <th scope="col">Name</th>
        <th scope="col">Employee ID</th>
        <th scope="col">Date</th>
        <th scope="col">Check In</th>
        <th scope="col">Check Out</th>
        <th scope="col">Attendance Status</th>
      </tr>
    </thead>
    <tbody>
        {% for i in data %}
      <tr style="background-color: #e6e6ff;">              
        <td>{{ i.full_name|title }}</td>
        <td>{{i.emp_id}}</td> 
        <td>{{i.attendance_date}}</td>
        <td>{{i.in_time}}</td>
        <td>{{i.out_time}}</td>
         <td>
  {% if i.emp_status == "Present" %}
    <span class="badge badge-success">Present</span>
  {% elif i.emp_status == "Absent" %}
    <span class="badge badge-danger">Absent</span>
  {% else %}
    <span class="badge badge-secondary">{{ i.emp_status }}</span>
  {% endif %}
</td>

        

      </tr>
      {% endfor %}
    </tbody>
  </table>
  </div>
  </div>


<!-- START MOdel for Mark Attendance ##########################################-->
   <div class="modal fade" id="markAttendanceModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content" style="border-radius: 15px;">

      <div class="modal-header">
        <h5 class="modal-title">Mark Attendance</h5>
        <button type="button" class="close" data-dismiss="modal">&times;</button>
      </div>

      <form method="post" action="{% url 'MarkAttendance' %}">
        {% csrf_token %}
        <div class="modal-body">

          <div class="form-group">
            <label>Select User <span style="color: red; font-size: 20px;">*</span></label>
            <select class="form-control" name="emp_id" required>
              <option value="">-- Select --</option>
              {% for i in model_data %}
                <option value="{{i.emp_id}}">{{i.email_address}}</option>
              {% endfor %}
            </select>
          </div>

          <div class="form-group">
            <label>Date <span style="color: red; font-size: 20px;">*</span></label>
            <input type="date" class="form-control" name="attendance_date" id="attendance_date" required>
          </div>

          <div class="row">
            <div class="col-md-6">
              <label>Check In</label>
              <input type="time" class="form-control" name="in_time" id="in_time">
            </div>
            <div class="col-md-6">
              <label>Check Out</label>
              <input type="time" class="form-control" name="out_time" id="out_time">
            </div>
          </div>

          <div class="form-group mt-3">
            <label>Status</label>
            <select class="form-control" name="emp_status">
              <option value="Present">Present</option>
              <option value="Absent">Absent</option>
            </select>
          </div>

        </div>

        <div class="modal-footer">
          <button class="btn btn-primary">Save</button>
          <button class="btn btn-secondary" data-dismiss="modal">Cancel</button>
        </div>
      </form>

    </div>
  </div>
</div>
<!-- END MOdel - Mark Attendance ############################################# -->
 


  <script>
    document.querySelectorAll('.delete-button').forEach(button => {
      button.addEventListener('click', function (event) {
        event.preventDefault();
        if (confirm('Are you sure you want to delete this record?')) {
          event.target.closest('form').submit();
        }
      });
    });
  </script> 



  <br> <br>

<!-- Start CDN for Pagingnation and static search boxes  -->
<script src="https://code.jquery.com/jquery-3.7.0.js"></script>
<script src="https://cdn.datatables.net/1.13.5/js/jquery.dataTables.min.js"></script>

<script>
  $(document).ready(function () {
    $('#myTable').DataTable();
  });
</script>
<!-- End CDN for Pagingnation and static search boxes -->

<!-- Start applying Validation on Attendance Date -->
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const dateInput = document.getElementById("attendance_date");

    const today = new Date();
    const past40Days = new Date();
    past40Days.setDate(today.getDate() - 40);

    const formatDate = (date) => {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    };

    dateInput.max = formatDate(today);       
    dateInput.min = formatDate(past40Days);  
  });
</script>
<!-- End Validation on Attendance Date -->

<!-- Start applying Validation on Check in and Check out -->
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const inTimeInput = document.getElementById("in_time");
    const outTimeInput = document.getElementById("out_time");

    outTimeInput.disabled = true;

    inTimeInput.addEventListener("change", function () {
      if (this.value) {
        outTimeInput.disabled = false;

        outTimeInput.min = this.value;

        if (outTimeInput.value && outTimeInput.value < this.value) {
          outTimeInput.value = "";
        }
      } else {
        outTimeInput.disabled = true;
        outTimeInput.value = "";
      }
    });
  });
</script>
<!-- End Validation on Check in and Check out -->
  {% endblock %}
